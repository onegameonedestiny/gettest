<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Firebase 4 äººæŒ‡ç¤ºç‡ˆæ¸¬è©¦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Firebase compat ç‰ˆæœ¬ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 10px;
    }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px;
      max-width: 480px;
      margin: 0 auto 16px auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .role-buttons button {
      margin: 4px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
    }
    .role-buttons button.selected {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }
    #game-screen {
      display: none;
    }
    #toggle-button {
      padding: 10px 16px;
      border-radius: 6px;
      border: none;
      background: #388e3c;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    #toggle-button.off {
      background: #b71c1c;
    }
    .players-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }
    .player-box {
      border-radius: 6px;
      padding: 8px;
      background: #fafafa;
      border: 1px solid #ddd;
      font-size: 13px;
    }
    .player-name {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .status-line {
      margin: 2px 0;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }
    .badge-joined {
      background: #2e7d32;
    }
    .badge-not-joined {
      background: #757575;
    }
    .badge-on {
      background: #f9a825;
    }
    .badge-off {
      background: #616161;
    }
  </style>
</head>
<body>
  <!-- é¸è§’è‰²ç•«é¢ -->
  <div id="setup-screen" class="card">
    <h1>é¸æ“‡ç©å®¶è§’è‰²ï¼ˆPLAY1ï½PLAY4ï¼‰</h1>
    <p>é–‹å…©å€‹ç€è¦½å™¨ / æ‰‹æ©Ÿï¼Œé¸ä¸åŒè§’è‰²ï¼Œå°±å¯ä»¥çœ‹åˆ°å½¼æ­¤æŒ‡ç¤ºç‡ˆåŒæ­¥ã€‚</p>
    <div class="role-buttons">
      <button onclick="selectPlayer('PLAY1')" id="btn-PLAY1">PLAY1</button>
      <button onclick="selectPlayer('PLAY2')" id="btn-PLAY2">PLAY2</button>
      <button onclick="selectPlayer('PLAY3')" id="btn-PLAY3">PLAY3</button>
      <button onclick="selectPlayer('PLAY4')" id="btn-PLAY4">PLAY4</button>
    </div>
    <p style="font-size:12px;color:#666;margin-top:8px;">
      â€» æ¸¬è©¦å‰è«‹å…ˆåœ¨ Firebase Realtime Database å°‡ rules è¨­ç‚ºï¼š<br>
      <code>{ "rules": { ".read": true, ".write": true } }</code>
    </p>
  </div>

  <!-- éŠæˆ²ç•«é¢ -->
  <div id="game-screen" class="card">
    <h1>æŒ‡ç¤ºç‡ˆåŒæ­¥æ¸¬è©¦</h1>
    <p>ç›®å‰èº«åˆ†ï¼š<strong id="current-player-label">-</strong></p>
    <button id="toggle-button" onclick="toggleLight()" disabled>é–‹å•ŸæŒ‡ç¤ºç‡ˆ</button>

    <h2 style="font-size:16px;margin-top:16px;">å››ä½ç©å®¶ç‹€æ…‹</h2>
    <div class="players-grid" id="players-grid">
      <div class="player-box" data-player-id="PLAY1">
        <div class="player-name">PLAY1</div>
        <div class="status-line">åŠ å…¥ï¼š<span class="joined-text">æœªåŠ å…¥</span> <span class="joined-badge badge badge-not-joined">æœªåŠ å…¥</span></div>
        <div class="status-line">æŒ‡ç¤ºç‡ˆï¼š<span class="light-text">é—œ</span> <span class="light-badge badge badge-off">OFF</span></div>
      </div>
      <div class="player-box" data-player-id="PLAY2">
        <div class="player-name">PLAY2</div>
        <div class="status-line">åŠ å…¥ï¼š<span class="joined-text">æœªåŠ å…¥</span> <span class="joined-badge badge badge-not-joined">æœªåŠ å…¥</span></div>
        <div class="status-line">æŒ‡ç¤ºç‡ˆï¼š<span class="light-text">é—œ</span> <span class="light-badge badge badge-off">OFF</span></div>
      </div>
      <div class="player-box" data-player-id="PLAY3">
        <div class="player-name">PLAY3</div>
        <div class="status-line">åŠ å…¥ï¼š<span class="joined-text">æœªåŠ å…¥</span> <span class="joined-badge badge badge-not-joined">æœªåŠ å…¥</span></div>
        <div class="status-line">æŒ‡ç¤ºç‡ˆï¼š<span class="light-text">é—œ</span> <span class="light-badge badge badge-off">OFF</span></div>
      </div>
      <div class="player-box" data-player-id="PLAY4">
        <div class="player-name">PLAY4</div>
        <div class="status-line">åŠ å…¥ï¼š<span class="joined-text">æœªåŠ å…¥</span> <span class="joined-badge badge badge-not-joined">æœªåŠ å…¥</span></div>
        <div class="status-line">æŒ‡ç¤ºç‡ˆï¼š<span class="light-text">é—œ</span> <span class="light-badge badge badge-off">OFF</span></div>
      </div>
    </div>
  </div>

  <script>
    // ğŸ”§ æŠŠé€™è£¡æ”¹æˆä½ çš„ Firebase è¨­å®š -----------------
    const firebaseConfig = {
    apiKey: "AIzaSyCK7sNXMML-IA_ZjaiAOXyN8ftCrLn39uA",
    authDomain: "theendoftheworld.firebaseapp.com",
      databaseURL: "https://theendoftheworld.asia-southeast1.firebasedatabase.app",
    projectId: "theendoftheworld",
    storageBucket: "theendoftheworld.appspot.com",
    messagingSenderId: "333484279077",
    appId: "1:333484279077:web:53ddd6067e1f4b45c3c6cc"
    };
    // ------------------------------------------------

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const playersRef = db.ref("demoGame/players");

    // ç•¶å‰ä½¿ç”¨ä¸­çš„è§’è‰²
    let currentPlayerId = null;
    let currentPlayerRef = null;
    let myLightOn = false;

    // é¸æ“‡è§’è‰²
    function selectPlayer(playerId) {
      if (!playerId) return;

      currentPlayerId = playerId;
      document.getElementById("current-player-label").textContent = playerId;

      // æŒ‰éˆ•æ¨£å¼æ›´æ–°
      ["PLAY1","PLAY2","PLAY3","PLAY4"].forEach(id => {
        const btn = document.getElementById("btn-" + id);
        if (btn) {
          btn.classList.toggle("selected", id === playerId);
        }
      });

      // åˆ‡æ›ç•«é¢
      document.getElementById("setup-screen").style.display = "none";
      document.getElementById("game-screen").style.display = "block";

      // æŒ‡å‘è‡ªå·±çš„ç©å®¶ç¯€é»
      currentPlayerRef = playersRef.child(playerId);

      // è¨»å†Š onDisconnectï¼šé›¢ç·šæ™‚è¨­å®šç‚ºæœªåŠ å…¥ & æŒ‡ç¤ºç‡ˆé—œ
      currentPlayerRef.onDisconnect().set({
        joined: false,
        light: false,
        updatedAt: Date.now()
      });

      // æ­£å¼å¯«å…¥ã€Œå·²åŠ å…¥ï¼Œç‡ˆé—œã€
      currentPlayerRef.set({
        joined: true,
        light: false,
        updatedAt: Date.now()
      });

      myLightOn = false;
      updateToggleButtonUI();

      // è®“æŒ‰éˆ•å¯ç”¨
      document.getElementById("toggle-button").disabled = false;
    }

    // åˆ‡æ›è‡ªå·±çš„æŒ‡ç¤ºç‡ˆ
    function toggleLight() {
      if (!currentPlayerRef) {
        alert("è«‹å…ˆé¸æ“‡è§’è‰²");
        return;
      }
      myLightOn = !myLightOn;
      currentPlayerRef.update({
        joined: true,
        light: myLightOn,
        updatedAt: Date.now()
      });
      updateToggleButtonUI();
    }

    // æ›´æ–°ç•«é¢ä¸Šè‡ªå·±çš„æŒ‰éˆ•æ–‡å­— / é¡è‰²
    function updateToggleButtonUI() {
      const btn = document.getElementById("toggle-button");
      if (!btn) return;

      if (myLightOn) {
        btn.textContent = "é—œé–‰æŒ‡ç¤ºç‡ˆ";
        btn.classList.add("off");
      } else {
        btn.textContent = "é–‹å•ŸæŒ‡ç¤ºç‡ˆ";
        btn.classList.remove("off");
      }
    }

    // ç›£è½æ‰€æœ‰ç©å®¶ç‹€æ…‹
    playersRef.on("value", snapshot => {
      const players = snapshot.val() || {};
      // æ›´æ–°å››å€‹ç©å®¶çš„æ ¼å­
      ["PLAY1","PLAY2","PLAY3","PLAY4"].forEach(id => {
        const box = document.querySelector(`.player-box[data-player-id="${id}"]`);
        if (!box) return;

        const data = players[id] || { joined: false, light: false };
        const joinedText = box.querySelector(".joined-text");
        const joinedBadge = box.querySelector(".joined-badge");
        const lightText = box.querySelector(".light-text");
        const lightBadge = box.querySelector(".light-badge");

        const joined = !!data.joined;
        const light = !!data.light;

        // åŠ å…¥ç‹€æ…‹
        joinedText.textContent = joined ? "å·²åŠ å…¥" : "æœªåŠ å…¥";
        joinedBadge.textContent = joined ? "å·²åŠ å…¥" : "æœªåŠ å…¥";
        joinedBadge.classList.toggle("badge-joined", joined);
        joinedBadge.classList.toggle("badge-not-joined", !joined);

        // æŒ‡ç¤ºç‡ˆç‹€æ…‹
        lightText.textContent = light ? "äº®" : "é—œ";
        lightBadge.textContent = light ? "ON" : "OFF";
        lightBadge.classList.toggle("badge-on", light);
        lightBadge.classList.toggle("badge-off", !light);

        // è‹¥æ˜¯è‡ªå·±ï¼Œé †ä¾¿åŒæ­¥ myLightOnï¼ˆé¿å…å¤šé–‹è¦–çª—æ™‚ä¸åŒæ­¥ï¼‰
        if (id === currentPlayerId) {
          myLightOn = light;
          updateToggleButtonUI();
        }
      });
    });
  </script>
</body>
</html>
